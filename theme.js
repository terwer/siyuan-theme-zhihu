"use strict";var st=Object.defineProperty;var ot=(i,t,n)=>t in i?st(i,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[t]=n;var w=(i,t,n)=>(ot(i,typeof t!="symbol"?t+"":t,n),n);var X=Object.defineProperty,J=(i,t,n)=>t in i?X(i,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[t]=n,s=(i,t,n)=>(J(i,typeof t!="symbol"?t+"":t,n),n),Q=Object.defineProperty,ee=(i,t,n)=>t in i?Q(i,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[t]=n,_=(i,t,n)=>(ee(i,typeof t!="symbol"?t+"":t,n),n),K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},P={},te={get exports(){return P},set exports(i){P=i}};(function(i){(function(t,n){i.exports?i.exports=n():t.log=n()})(K,function(){var t=function(){},n="undefined",o=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function a(m,S){var L=m[S];if(typeof L.bind=="function")return L.bind(m);try{return Function.prototype.bind.call(L,m)}catch{return function(){return Function.prototype.apply.apply(L,[m,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(m){return m==="debug"&&(m="log"),typeof console===n?!1:m==="trace"&&o?l:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):t}function u(m,S){for(var L=0;L<r.length;L++){var y=r[L];this[y]=L<m?t:this.methodFactory(y,m,S)}this.log=this.debug}function h(m,S,L){return function(){typeof console!==n&&(u.call(this,S,L),this[m].apply(this,arguments))}}function g(m,S,L){return c(m)||h.apply(this,arguments)}function d(m,S,L){var y=this,x;S=S??"WARN";var E="loglevel";typeof m=="string"?E+=":"+m:typeof m=="symbol"&&(E=void 0);function C(f){var U=(r[f]||"silent").toUpperCase();if(!(typeof window===n||!E)){try{window.localStorage[E]=U;return}catch{}try{window.document.cookie=encodeURIComponent(E)+"="+U+";"}catch{}}}function z(){var f;if(!(typeof window===n||!E)){try{f=window.localStorage[E]}catch{}if(typeof f===n)try{var U=window.document.cookie,k=U.indexOf(encodeURIComponent(E)+"=");k!==-1&&(f=/^([^;]+)/.exec(U.slice(k))[1])}catch{}return y.levels[f]===void 0&&(f=void 0),f}}function tt(){if(!(typeof window===n||!E)){try{window.localStorage.removeItem(E);return}catch{}try{window.document.cookie=encodeURIComponent(E)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}y.name=m,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=L||g,y.getLevel=function(){return x},y.setLevel=function(f,U){if(typeof f=="string"&&y.levels[f.toUpperCase()]!==void 0&&(f=y.levels[f.toUpperCase()]),typeof f=="number"&&f>=0&&f<=y.levels.SILENT){if(x=f,U!==!1&&C(f),u.call(y,f,m),typeof console===n&&f<y.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+f},y.setDefaultLevel=function(f){S=f,z()||y.setLevel(f,!1)},y.resetLevel=function(){y.setLevel(S,!1),tt()},y.enableAll=function(f){y.setLevel(y.levels.TRACE,f)},y.disableAll=function(f){y.setLevel(y.levels.SILENT,f)};var O=z();O==null&&(O=S),y.setLevel(O,!1)}var p=new d,v={};p.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var S=v[m];return S||(S=v[m]=new d(m,p.getLevel(),p.methodFactory)),S};var D=typeof window!==n?window.log:void 0;return p.noConflict=function(){return typeof window!==n&&window.log===p&&(window.log=D),p},p.getLoggers=function(){return v},p.default=p,p})})(te);var A={},ne={get exports(){return A},set exports(i){A=i}};(function(i){(function(t,n){i.exports?i.exports=n():t.prefix=n(t)})(K,function(t){var n=function(g){for(var d=1,p=arguments.length,v;d<p;d++)for(v in arguments[d])Object.prototype.hasOwnProperty.call(arguments[d],v)&&(g[v]=arguments[d][v]);return g},o={template:"[%t] %l:",levelFormatter:function(g){return g.toUpperCase()},nameFormatter:function(g){return g||"root"},timestampFormatter:function(g){return g.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},r,a={},l=function(g){if(!g||!g.getLogger)throw new TypeError("Argument is not a root logger");r=g},c=function(g,d){if(!g||!g.setLevel)throw new TypeError("Argument is not a logger");var p=g.methodFactory,v=g.name||"",D=a[v]||a[""]||o;function m(S,L,y){var x=p(S,L,y),E=a[y]||a[""],C=E.template.indexOf("%t")!==-1,z=E.template.indexOf("%l")!==-1,tt=E.template.indexOf("%n")!==-1;return function(){for(var O="",f=arguments.length,U=Array(f),k=0;k<f;k++)U[k]=arguments[k];if(v||!a[y]){var et=E.timestampFormatter(new Date),it=E.levelFormatter(S),nt=E.nameFormatter(y);E.format?O+=E.format(it,nt,et):(O+=E.template,C&&(O=O.replace(/%t/,et)),z&&(O=O.replace(/%l/,it)),tt&&(O=O.replace(/%n/,nt))),U.length&&typeof U[0]=="string"?U[0]=O+" "+U[0]:U.unshift(O)}x.apply(void 0,U)}}return a[v]||(g.methodFactory=m),d=d||{},d.template&&(d.format=void 0),a[v]=n({},D,d),g.setLevel(g.getLevel()),r||g.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),g},u={reg:l,apply:c},h;return t&&(h=t.prefix,u.noConflict=function(){return t.prefix===u&&(t.prefix=h),u}),u})})(ne);class R{}_(R,"LOG_LEVEL_KEY","VITE_LOG_LEVEL"),_(R,"LOG_PREFIX_KEY","VITE_LOG_PREFIX");var T=(i=>(i.LOG_LEVEL_DEBUG="DEBUG",i.LOG_LEVEL_INFO="INFO",i.LOG_LEVEL_WARN="WARN",i.LOG_LEVEL_ERROR="ERROR",i))(T||{});function re(){const i=Error.prepareStackTrace;Error.prepareStackTrace=(n,o)=>o;const t=new Error().stack.slice(1);return Error.prepareStackTrace=i,t}class N{static stringToEnumValue(t,n){return t[Object.keys(t).filter(o=>t[o].toString()===n)[0]]}static getEnvLevel(t){if(!t)return;const n=t.getEnvOrDefault(R.LOG_LEVEL_KEY,T.LOG_LEVEL_INFO),o=N.stringToEnumValue(T,n.toUpperCase());return o||console.warn("[zhi-log] LOG_LEVEL is invalid in you .env file.Must be either debug, info, warn or error, fallback to default info level"),o}static getEnvLogger(t){if(t)return t.getEnv(R.LOG_PREFIX_KEY)}}class ie{constructor(t,n,o){_(this,"consoleLogger","console"),_(this,"stackSize",1),_(this,"getLogger",l=>{let c;if(l)c=l;else{const u=re(),h=[];for(let g=0;g<u.length;g++){const d=u[g],p=d.getFileName()??"none";if(!p.includes(".ts")&&!p.includes(".js")&&!p.includes(".cjs")&&!p.includes(".mjs")&&!p.includes(".vue")&&!p.includes(".tsx"))continue;if(g>this.stackSize-1)break;const v=p+"-"+d.getLineNumber()+":"+d.getColumnNumber();h.push(v)}u.length>0&&(c=h.join(" -> "))}return(!c||c.trim().length===0)&&(c=this.consoleLogger),P.getLogger(c)}),this.stackSize=1;let r;t?r=t:r=N.getEnvLevel(o),r=r??T.LOG_LEVEL_INFO,P.setLevel(r);const a={gray:l=>l.toString(),green:l=>l.toString(),yellow:l=>l.toString(),red:l=>l.toString()};A.reg(P),A.apply(P,{format(l,c,u){const h=["["+(n??N.getEnvLogger(o)??"zhi")+"]"];switch(h.push(a.gray("[")+a.green(u).toString()+a.gray("]")),l){case T.LOG_LEVEL_DEBUG:h.push(a.gray(l.toUpperCase().toString()));break;case T.LOG_LEVEL_INFO:h.push(a.green(l.toUpperCase().toString()));break;case T.LOG_LEVEL_WARN:h.push(a.yellow(l.toUpperCase().toString()));break;case T.LOG_LEVEL_ERROR:h.push(a.red(l.toUpperCase().toString()));break}return h.push(a.green(c).toString()),h.push(a.gray(":")),h.join(" ")}})}setStackSize(t){this.stackSize=t??1}}class oe{constructor(t,n,o){_(this,"logger"),this.logger=new ie(t,n,o)}getLogger(t,n){return this.logger.setStackSize(n),this.logger.getLogger(t)}}class q extends oe{constructor(t,n,o){super(t,n,o)}getLogger(t,n){return super.getLogger(t,n)}}class W{static defaultLogger(t,n){return W.customLogFactory(void 0,void 0,t).getLogger(void 0,n)}static customLogFactory(t,n,o){return new q(t,n,o)}static customSignLogFactory(t,n){return new q(void 0,t,n)}}class Y{}s(Y,"LOG_STACK_SIZE",1);const H="1.0.10";class se{constructor(){s(this,"VERSION"),this.VERSION=H}}class ae{constructor(){s(this,"VERSION"),this.VERSION=H}}const b=class{constructor(){s(this,"getQueryString",i=>{if(!b.isInBrowser)return"";const t=window.location.search.substring(1).split("&");for(let n=0;n<t.length;n++){const o=t[n].split("=");if(o[0]===i)return o[1]}return""})}static isInChromeExtension(){return b.isInBrowser?window.location.href.indexOf("chrome-extension://")>-1:!1}};let I=b;s(I,"isInBrowser",typeof window<"u"),s(I,"isElectron",()=>!b.isInBrowser||!window.navigator||!window.navigator.userAgent?!1:/Electron/.test(window.navigator.userAgent)),s(I,"replaceUrlParam",(i,t,n)=>{n==null&&(n="");const o=new RegExp("\\b("+t+"=).*?(&|#|$)");return i.search(o)>=0?i.replace(o,"$1"+n+"$2"):(i=i.replace(/[?#]$/,""),i+(i.indexOf("?")>0?"&":"?")+t+"="+n)}),s(I,"setUrlParameter",(i,t,n)=>b.isInBrowser?i.includes(t)?b.replaceUrlParam(i,t,n):(i+=(i.match(/[?]/g)!=null?"&":"?")+t+"="+n,i):""),s(I,"reloadTabPage",i=>{setTimeout(function(){if(b.isInBrowser){const t=window.location.href;window.location.href=b.setUrlParameter(t,"tab",i)}},200)}),s(I,"reloadPage",()=>{setTimeout(function(){b.isInBrowser&&window.location.reload()},200)}),s(I,"reloadPageWithMessageCallback",(i,t)=>{t&&t(),setTimeout(function(){b.isInBrowser&&window.location.reload()},200)});class G{constructor(){s(this,"isInSiyuanWidget",()=>typeof window>"u"?!1:window.frameElement!=null&&window.frameElement.parentElement!=null&&window.frameElement.parentElement.parentElement!=null&&window.frameElement.parentElement.parentElement.getAttribute("data-node-id")!==""),s(this,"isInSiyuanNewWin",()=>typeof window>"u"?!1:typeof window.terwer<"u"),s(this,"isInSiyuanOrSiyuanNewWin",()=>I.isElectron)}siyuanWindow(){let t;return this.isInSiyuanWidget()?t=parent.window:this.isInSiyuanNewWin()||typeof window<"u"?t=window:t=void 0,t}}class le{constructor(){s(this,"serverApi"),s(this,"clientApi"),s(this,"siyuanUtil"),this.serverApi=new se,this.clientApi=new ae,this.siyuanUtil=new G}}class ce{constructor(){s(this,"VERSION"),this.VERSION="1.0.0"}}class ue{f(t,...n){let o=t;for(let r=0;r<n.length;r++){const a=n[r];typeof a=="string"?o=o.replace(`{${r}}`,a):o=o.replace(`{${r}}`,a.toString())}return o}}class pe{constructor(){s(this,"TIME_SPLIT"," "),s(this,"formatIsoToZhDate",(t,n,o)=>{if(!t)return"";let r=t;const a=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(.\d{3})Z$/gm,l=r.match(a);if(l==null)return t;for(let c=0;c<l.length;c++){const u=l[c];let h=u;n&&(h=this.addHoursToDate(new Date(u),8).toISOString());const g=h.split("T"),d=g[0],p=g[1].split(".")[0];let v=d+this.TIME_SPLIT+p;o&&(v=d),r=r.replace(u,v)}return r})}addHoursToDate(t,n){return t.setTime(t.getTime()+n*60*60*1e3),t}nowZh(){return this.formatIsoToZhDate(new Date().toISOString())}nowDateZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0,!0)}nowTimeZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0).split(this.TIME_SPLIT)[1]}}const V=(i,t)=>{const n=Z(i),o=Z(t),r=n.pop(),a=o.pop(),l=$(n,o);return l!==0?l:r&&a?$(r.split("."),a.split(".")):r||a?r?-1:1:0},he=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,Z=i=>{if(typeof i!="string")throw new TypeError("Invalid argument expected string");const t=i.match(he);if(!t)throw new Error(`Invalid argument not valid semver ('${i}' received)`);return t.shift(),t},B=i=>i==="*"||i==="x"||i==="X",M=i=>{const t=parseInt(i,10);return isNaN(t)?i:t},ge=(i,t)=>typeof i!=typeof t?[String(i),String(t)]:[i,t],fe=(i,t)=>{if(B(i)||B(t))return 0;const[n,o]=ge(M(i),M(t));return n>o?1:n<o?-1:0},$=(i,t)=>{for(let n=0;n<Math.max(i.length,t.length);n++){const o=fe(i[n]||"0",t[n]||"0");if(o!==0)return o}return 0};class de{greater(t,n){return V(t,n)>0}equal(t,n){return V(t,n)===0}lesser(t,n){return V(t,n)<0}}class ye{static getDevice(){const t=new G;return t.isInSiyuanWidget()?"Siyuan_Widget":t.isInSiyuanOrSiyuanNewWin()?"Siyuan_NewWin":I.isInChromeExtension()?"Chrome_Extension":"Chrome_Browser"}}class me{constructor(){s(this,"siyuanUtil"),s(this,"requireLib",t=>{const n=this.siyuanUtil.siyuanWindow();return n?n.require(t):require(t)}),s(this,"getCrossPlatformAppDataFolder",()=>{var t,n,o,r,a,l;const c=this.requireLib("path");let u;return((t=this.syProcess())==null?void 0:t.platform)==="darwin"?u=c.join((n=this.syProcess())==null?void 0:n.env.HOME,"/Library/Application Support"):((o=this.syProcess())==null?void 0:o.platform)==="win32"?u=(r=this.syProcess())==null?void 0:r.env.APPDATA:((a=this.syProcess())==null?void 0:a.platform)==="linux"&&(u=(l=this.syProcess())==null?void 0:l.env.HOME),u}),this.siyuanUtil=new G}copyFolderSync(t,n){const o=this,r=this.requireLib("fs"),a=this.requireLib("path");r.existsSync(n)||r.mkdirSync(n),r.lstatSync(t).isDirectory()&&r.readdirSync(t).forEach(function(l){const c=a.join(t,l);r.lstatSync(c).isDirectory()?o.copyFolderSync(c,a.join(n,l)):r.copyFileSync(c,a.join(n,l))})}rmFolder(t){const n=this.requireLib("fs");n.existsSync(t)&&n.rmdirSync(t,{recursive:!0})}joinPath(...t){return this.requireLib("path").join(...t)}dirname(t){return this.requireLib("path").dirname(t)}absPath(t){const n=this.requireLib("path"),o=this.dirname(t);return n.resolve(n.dirname(o),t)}syProcess(){return I.isInBrowser?window.process:process}siyuanConfPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t==null?void 0:t.siyuan.config.system.confDir}siyuanDataPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t.siyuan.config.system.dataDir}siyuanAppearancePath(){return this.requireLib("path").join(this.siyuanConfPath(),"appearance")}siyuanThemePath(){return this.requireLib("path").join(this.siyuanAppearancePath(),"themes")}zhiThemePath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi")}zhiThemeDistPath(){return this.requireLib("path").join(this.zhiThemePath(),"apps","theme","dist")}zhiBlogDistPath(){return this.requireLib("path").join(this.siyuanThemePath(),"apps","blog","dist")}zhiMiniPath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi-mini")}}class ve{constructor(){s(this,"strUtil"),s(this,"dateUtil"),s(this,"electronUtil"),s(this,"browserUtil"),s(this,"versionUtil"),s(this,"deviceUtil"),this.strUtil=new ue,this.dateUtil=new pe,this.electronUtil=new me,this.browserUtil=I,this.versionUtil=new de,this.deviceUtil=ye}}class Ee{constructor(t){s(this,"env"),s(this,"logger"),s(this,"siyuanApi"),s(this,"blogApi"),s(this,"common"),this.env=t,this.logger=W.defaultLogger(this.env,Y.LOG_STACK_SIZE),this.siyuanApi=new le,this.blogApi=new ce,this.common=new ve}getEnv(){if(!this.env)throw new Error("env is not initiated, please use new ZhiSdk(env) create ZhiSdk object!");return this.env}getLogger(){return this.logger}}function getDefaultExportFromCjs(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var lib={};(function(i){var t=Object.defineProperty,n=(l,c,u)=>c in l?t(l,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[c]=u,o=(l,c,u)=>(n(l,typeof c!="symbol"?c+"":c,u),u);Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});class r{}o(r,"NODE_ENV_KEY","NODE_ENV"),o(r,"VITE_DEBUG_MODE_KEY","VITE_DEBUG_MODE");class a{constructor(c){o(this,"envMeta"),this.envMeta=c}isNodeDev(){return this.getEnv(r.NODE_ENV_KEY)==="development"}isDev(){return this.isNodeDev()||this.getBooleanEnv(r.VITE_DEBUG_MODE_KEY)}getEnv(c){let u;try{this.envMeta[c]&&(u=this.envMeta[c])}catch(h){console.error(h)}return u}getStringEnv(c){return this.getEnv(c)??""}getBooleanEnv(c){let u=!1;return this.getEnv(c)&&(u=this.getStringEnv(c).toLowerCase()==="true"),u}getEnvOrDefault(c,u){const h=this.getStringEnv(c);return h.trim().length==0?u:h}}i.EnvConstants=r,i.default=a})(lib);const Env=getDefaultExportFromCjs(lib),F=class{static zhiSdk(){if(!F.zhiSdkObj){const t=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"false",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1});F.zhiSdkObj=new Ee(t)}return F.zhiSdkObj}};let ZhiUtil=F;w(ZhiUtil,"zhiSdkObj");const version="0.0.1";var ThemeFromEnum=(i=>(i.ThemeFrom_mini_Siyuan="zhi-mini-siyuan",i))(ThemeFromEnum||{});class HackPluginSystem{constructor(){w(this,"logger");w(this,"common");w(this,"siyuanApi");w(this,"ZHI_PLUGIN_FOLDER","zhi-plugins");w(this,"PLUGIN_FOLDER","plugins");w(this,"MANIFEST","manifest.json");w(this,"OLD_VERSION_ZERO","0.0.0");w(this,"SCRIPT","main.js");w(this,"getFileContent",async i=>{const t=this.common.electronUtil.requireLib("fs");return new Promise((n,o)=>{t.readFile(i,(r,a)=>{if(r){o(r);return}return n(a.toString("utf8"))})})});w(this,"getManifest",async i=>{const t=await this.getFileContent(i);try{return JSON.parse(t)}catch(n){return this.logger.error("Lading manifest: "+i,n),null}});w(this,"getPluginSystem",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystem);w(this,"getPluginSystemVersion",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystemVersion);const i=ZhiUtil.zhiSdk();this.logger=i.getLogger(),this.common=i.common,this.siyuanApi=i.siyuanApi}isDir(i){return this.common.electronUtil.requireLib("fs").statSync(i).isDirectory()}isExists(i){try{return this.common.electronUtil.requireLib("fs").statSync(i),!0}catch{return!1}}async scanPlugins(i){const t=this,n=this.common.electronUtil.requireLib("fs"),o=this.common.electronUtil.requireLib("path");return new Promise((r,a)=>{n.readdir(i,(l,c)=>{var u;if(l){t.logger.error(l),r([]);return}r(((u=c.filter(h=>this.isDir(o.join(i,h))&&this.isExists(o.join(i,h,t.MANIFEST))&&this.isExists(o.join(i,h,t.SCRIPT))))==null?void 0:u.map(h=>o.resolve(i,h)))||[])})})}async initPluginSystem(){const pluginSystem=this.getPluginSystem();if(pluginSystem){this.logger.warn("Plugin system already loaded by snapshots, ignore initiation."),this.logger.warn("Loaded plugin system version is ",this.getPluginSystemVersion());return}try{this.logger.info("Undetected plugin systemï¼Œinitiating plugin system...");const fs=this.common.electronUtil.requireLib("fs"),path=this.common.electronUtil.requireLib("path"),data=fs.readFileSync(path.join(this.common.electronUtil.getCrossPlatformAppDataFolder(),".siyuan","plugin.js")),script=data.toString("utf8");this.logger.info("Local plugin system found, loading..."),eval(script)}catch(e){this.logger.info("Local plugin system not found, load online"),this.logger.debug("Plugin system Load error",e);const res=await fetch("https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",{cache:"no-cache"}),sc=await res.text();this.siyuanApi.siyuanUtil.siyuanWindow().siyuanPluginScript=sc,eval(sc)}const sys=this.getPluginSystem(),sysv=this.getPluginSystemVersion()??"unknown";return this.logger.info(this.common.strUtil.f("Plugin system inited, version => {0}.",sysv)),Promise.resolve(sys)}}class PluginSystemHook{constructor(){w(this,"logger");w(this,"common");w(this,"siyuanApi");w(this,"hack");const t=ZhiUtil.zhiSdk();this.logger=t.getLogger(),this.common=t.common,this.siyuanApi=t.siyuanApi,this.hack=new HackPluginSystem}getOldPluginInfo(t,n){let o=!1,r=!1,a=this.hack.OLD_VERSION_ZERO;const l=t.pslm.storageMangager.thirdPartyPlugins;for(const c of l)n.name===c.name&&(this.common.versionUtil.greater(n.version,c.version)&&(r=!0),a=c.version,o=!0);return{isSynced:o,oldVersion:a,isUpdate:r}}async syncZhiPlugins(t){this.logger.info("Start syncing zhi plugins ...");const n=this.common.electronUtil.requireLib("fs"),o=this.common.electronUtil.requireLib("path"),r=this.common.electronUtil.joinPath(this.common.electronUtil.zhiMiniPath(),"lib",this.hack.ZHI_PLUGIN_FOLDER);this.logger.debug("Zhi plugins folder=>",r);const a=this.common.electronUtil.joinPath(this.common.electronUtil.siyuanDataPath(),this.hack.PLUGIN_FOLDER);this.logger.debug("Plugins folder=>",a);let l=0,c=[];if(!n.existsSync(r))this.logger.warn("No zhi plugins found, stop!");else{c=await this.hack.scanPlugins(r);for(const u of c){const h=o.basename(u),g=u,d=o.join(a,h);this.logger.debug(this.common.strUtil.f("Try syncing zhi plugin {0}",h));const p=await this.hack.getManifest(o.join(u,this.hack.MANIFEST)),v=this.getOldPluginInfo(t,p),D=v.oldVersion;if(this.logger.info(this.common.strUtil.f("Plugin status : [{0}] isSynced=>{1}, isUpdate=>{2}, forceUpdate=>{3}, version Info: {4} -> {5}",h,v.isSynced,v.isUpdate,p.forceUpdate,D,p.version)),v.isSynced)if(v.isSynced&&v.isUpdate){if(!n.existsSync(d))throw new Error(this.common.strUtil.f("Conflict plugin exists, manifest exists but dest folder is not correct with original, please fix plugin folder name.Expected forder is=>{0}",d));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(g,d),l++}else p.forceUpdate?(this.logger.warn(this.common.strUtil.f("Find forceUpdate flag in manifest.json, try forcing update plugin, [{0}] {1}.This flag is development only, before publish plugin, you should remove this flag from manifest.json!",h,p.version)),this.common.electronUtil.rmFolder(d),this.common.electronUtil.copyFolderSync(g,d),l++):this.logger.debug(this.common.strUtil.f("Already synced and the latest version [{0}] {1}",h,p.version));else{if(n.existsSync(d))throw new Error(this.common.strUtil.f("Expected forder already exists=>{0}",d));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(g,d),l++}}}this.logger.info(this.common.strUtil.f("Zhi theme plugins Synced.Scaned {0}, synced {1} plugin(s).",c.length,l)),l>0&&this.logger.warn(this.common.strUtil.f("Synced {0} zhi plugins, you need to reload siyuan to take effect.",l))}async init(){const t=await this.hack.initPluginSystem();if(!t){this.logger.error("Plugin system init error, some feature may not work!");return}await this.syncZhiPlugins(t),this.logger.info("PluginSystem inited.")}}class PluginSystem{async initPluginSystem(){return await new PluginSystemHook().init(),Promise.resolve([])}}const pluginSystem=new PluginSystem;class Lifecycle{constructor(){w(this,"_dynamicImports",[])}get dynamicImports(){return this._dynamicImports}async load(){const t=[],n=await this.loadPluginSystem(),o=await this.loadWidgets(),r=await this.loadVendors();this._dynamicImports=t.concat(n).concat(o).concat(r)}async loadPluginSystem(){return await pluginSystem.initPluginSystem()}async loadWidgets(){return Promise.resolve([])}async loadVendors(){return Promise.resolve([])}}const j=class{static async start(){return await j.lifecycle.load(),Promise.resolve(j.lifecycle.dynamicImports)}};let Bootstrap=j;w(Bootstrap,"lifecycle"),(()=>{j.lifecycle=new Lifecycle})();class Zhi{constructor(){w(this,"logger");w(this,"common");const t=ZhiUtil.zhiSdk();this.logger=t.getLogger(),this.common=t.common}async main(t){return this.logger.debug(this.common.strUtil.f("Parsing args <{0}> ...",t)),this.hello(ThemeFromEnum.ThemeFrom_mini_Siyuan),await Bootstrap.start()}hello(t){this.logger.info(this.common.strUtil.f("Hello, {0} {1} v{2}! You are from {3}","zhi","mini",version,t))}}class Theme{constructor(){w(this,"logger");w(this,"common");w(this,"siyuanApi");w(this,"zhiTheme");const t=ZhiUtil.zhiSdk();this.logger=t.getLogger(),this.common=t.common,this.siyuanApi=t.siyuanApi,this.zhiTheme=new Zhi}async init(t){try{const n=await this.zhiTheme.main([]);for(const o of n){const r=o.libpath;if(o.format!=="cjs"&&o.format!=="js"){this.logger.warn("Only cjs supported, skip this lib!",r);continue}if(t&&t!==o.runAs){this.logger.warn(this.common.strUtil.f("This lib can only run at {0}, skip!Lib is=>{1}",o.runAs,o.libpath));continue}this.logger.info("Loading dependency=>",r);let a;if(this.common.browserUtil.isInBrowser){const l=this.common.electronUtil.joinPath(this.common.electronUtil.zhiMiniPath(),r);a=this.common.electronUtil.requireLib(l)}a&&a.init&&await a.init()}this.logger.info("Theme inited.")}catch(n){this.logger.error("Theme load error=>",n)}}}function callsites(){const i=Error.prepareStackTrace;Error.prepareStackTrace=(n,o)=>o;const t=new Error().stack.slice(1);return Error.prepareStackTrace=i,t}(async()=>{const i=ZhiUtil.zhiSdk(),t=i.getLogger(),n=i.getEnv(),o=async()=>{t.debug("Theme is loading..."),await new Theme().init("electron"),t.debug("Theme loaded.")};if(n.isDev()){const r=callsites(),a="theme.js";(r.length>0?r[0].getFileName()??a:a).includes(a)?await import("http://localhost:5173/theme.ts"):await o()}else await o()})();
