"use strict";var oe=Object.defineProperty;var ie=(r,e,t)=>e in r?oe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var I=(r,e,t)=>(ie(r,typeof e!="symbol"?e+"":e,t),t);var se=Object.defineProperty,ae=(r,e,t)=>e in r?se(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,c=(r,e,t)=>(ae(r,typeof e!="symbol"?e+"":e,t),t),le=Object.defineProperty,ce=(r,e,t)=>e in r?le(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,U=(r,e,t)=>(ce(r,typeof e!="symbol"?e+"":e,t),t),Q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},P={},ue={get exports(){return P},set exports(r){P=r}};(function(r){(function(e,t){r.exports?r.exports=t():e.log=t()})(Q,function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"];function i(h,w){var E=h[w];if(typeof E.bind=="function")return E.bind(h);try{return Function.prototype.bind.call(E,h)}catch{return function(){return Function.prototype.apply.apply(E,[h,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(h){return h==="debug"&&(h="log"),typeof console===t?!1:h==="trace"&&n?s:console[h]!==void 0?i(console,h):console.log!==void 0?i(console,"log"):e}function l(h,w){for(var E=0;E<o.length;E++){var p=o[E];this[p]=E<h?e:this.methodFactory(p,h,w)}this.log=this.debug}function m(h,w,E){return function(){typeof console!==t&&(l.call(this,w,E),this[h].apply(this,arguments))}}function u(h,w,E){return a(h)||m.apply(this,arguments)}function d(h,w,E){var p=this,N;w=w??"WARN";var y="loglevel";typeof h=="string"?y+=":"+h:typeof h=="symbol"&&(y=void 0);function C(g){var L=(o[g]||"silent").toUpperCase();if(!(typeof window===t||!y)){try{window.localStorage[y]=L;return}catch{}try{window.document.cookie=encodeURIComponent(y)+"="+L+";"}catch{}}}function j(){var g;if(!(typeof window===t||!y)){try{g=window.localStorage[y]}catch{}if(typeof g===t)try{var L=window.document.cookie,_=L.indexOf(encodeURIComponent(y)+"=");_!==-1&&(g=/^([^;]+)/.exec(L.slice(_))[1])}catch{}return p.levels[g]===void 0&&(g=void 0),g}}function G(){if(!(typeof window===t||!y)){try{window.localStorage.removeItem(y);return}catch{}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}p.name=h,p.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},p.methodFactory=E||u,p.getLevel=function(){return N},p.setLevel=function(g,L){if(typeof g=="string"&&p.levels[g.toUpperCase()]!==void 0&&(g=p.levels[g.toUpperCase()]),typeof g=="number"&&g>=0&&g<=p.levels.SILENT){if(N=g,L!==!1&&C(g),l.call(p,g,h),typeof console===t&&g<p.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+g},p.setDefaultLevel=function(g){w=g,j()||p.setLevel(g,!1)},p.resetLevel=function(){p.setLevel(w,!1),G()},p.enableAll=function(g){p.setLevel(p.levels.TRACE,g)},p.disableAll=function(g){p.setLevel(p.levels.SILENT,g)};var S=j();S==null&&(S=w),p.setLevel(S,!1)}var f=new d,v={};f.getLogger=function(h){if(typeof h!="symbol"&&typeof h!="string"||h==="")throw new TypeError("You must supply a name when creating a logger.");var w=v[h];return w||(w=v[h]=new d(h,f.getLevel(),f.methodFactory)),w};var z=typeof window!==t?window.log:void 0;return f.noConflict=function(){return typeof window!==t&&window.log===f&&(window.log=z),f},f.getLoggers=function(){return v},f.default=f,f})})(ue);var R={},he={get exports(){return R},set exports(r){R=r}};(function(r){(function(e,t){r.exports?r.exports=t():e.prefix=t(e)})(Q,function(e){var t=function(u){for(var d=1,f=arguments.length,v;d<f;d++)for(v in arguments[d])Object.prototype.hasOwnProperty.call(arguments[d],v)&&(u[v]=arguments[d][v]);return u},n={template:"[%t] %l:",levelFormatter:function(u){return u.toUpperCase()},nameFormatter:function(u){return u||"root"},timestampFormatter:function(u){return u.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},o,i={},s=function(u){if(!u||!u.getLogger)throw new TypeError("Argument is not a root logger");o=u},a=function(u,d){if(!u||!u.setLevel)throw new TypeError("Argument is not a logger");var f=u.methodFactory,v=u.name||"",z=i[v]||i[""]||n;function h(w,E,p){var N=f(w,E,p),y=i[p]||i[""],C=y.template.indexOf("%t")!==-1,j=y.template.indexOf("%l")!==-1,G=y.template.indexOf("%n")!==-1;return function(){for(var S="",g=arguments.length,L=Array(g),_=0;_<g;_++)L[_]=arguments[_];if(v||!i[p]){var W=y.timestampFormatter(new Date),Z=y.levelFormatter(w),K=y.nameFormatter(p);y.format?S+=y.format(Z,K,W):(S+=y.template,C&&(S=S.replace(/%t/,W)),j&&(S=S.replace(/%l/,Z)),G&&(S=S.replace(/%n/,K))),L.length&&typeof L[0]=="string"?L[0]=S+" "+L[0]:L.unshift(S)}N.apply(void 0,L)}}return i[v]||(u.methodFactory=h),d=d||{},d.template&&(d.format=void 0),i[v]=t({},z,d),u.setLevel(u.getLevel()),o||u.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),u},l={reg:s,apply:a},m;return e&&(m=e.prefix,l.noConflict=function(){return e.prefix===l&&(e.prefix=m),l}),l})})(he);class V{}U(V,"LOG_LEVEL_KEY","VITE_LOG_LEVEL"),U(V,"LOG_PREFIX_KEY","VITE_LOG_PREFIX");var O=(r=>(r.LOG_LEVEL_DEBUG="DEBUG",r.LOG_LEVEL_INFO="INFO",r.LOG_LEVEL_WARN="WARN",r.LOG_LEVEL_ERROR="ERROR",r))(O||{});function ge(){const r=Error.prepareStackTrace;Error.prepareStackTrace=(t,n)=>n;const e=new Error().stack.slice(1);return Error.prepareStackTrace=r,e}class x{static stringToEnumValue(e,t){return e[Object.keys(e).filter(n=>e[n].toString()===t)[0]]}static getEnvLevel(e){if(!e)return;const t=e.getEnvOrDefault(V.LOG_LEVEL_KEY,O.LOG_LEVEL_INFO),n=x.stringToEnumValue(O,t.toUpperCase());return n||console.warn("[zhi-log] LOG_LEVEL is invalid in you .env file.Must be either debug, info, warn or error, fallback to default info level"),n}static getEnvLogger(e){if(e)return e.getEnv(V.LOG_PREFIX_KEY)}}class pe{constructor(e,t,n){U(this,"consoleLogger","console"),U(this,"stackSize",1),U(this,"getLogger",s=>{let a;if(s)a=s;else{const l=ge(),m=[];for(let u=0;u<l.length;u++){const d=l[u],f=d.getFileName()??"none";if(!f.includes(".ts")&&!f.includes(".js")&&!f.includes(".cjs")&&!f.includes(".mjs")&&!f.includes(".vue")&&!f.includes(".tsx"))continue;if(u>this.stackSize-1)break;const v=f+"-"+d.getLineNumber()+":"+d.getColumnNumber();m.push(v)}l.length>0&&(a=m.join(" -> "))}return(!a||a.trim().length===0)&&(a=this.consoleLogger),P.getLogger(a)}),this.stackSize=1;let o;e?o=e:o=x.getEnvLevel(n),o=o??O.LOG_LEVEL_INFO,P.setLevel(o);const i={gray:s=>s.toString(),green:s=>s.toString(),yellow:s=>s.toString(),red:s=>s.toString()};R.reg(P),R.apply(P,{format(s,a,l){const m=["["+(t??x.getEnvLogger(n)??"zhi")+"]"];switch(m.push(i.gray("[")+i.green(l).toString()+i.gray("]")),s){case O.LOG_LEVEL_DEBUG:m.push(i.gray(s.toUpperCase().toString()));break;case O.LOG_LEVEL_INFO:m.push(i.green(s.toUpperCase().toString()));break;case O.LOG_LEVEL_WARN:m.push(i.yellow(s.toUpperCase().toString()));break;case O.LOG_LEVEL_ERROR:m.push(i.red(s.toUpperCase().toString()));break}return m.push(i.green(a).toString()),m.push(i.gray(":")),m.join(" ")}})}setStackSize(e){this.stackSize=e??1}}class me{constructor(e,t,n){U(this,"logger"),this.logger=new pe(e,t,n)}getLogger(e,t){return this.logger.setStackSize(t),this.logger.getLogger(e)}}class Y extends me{constructor(e,t,n){super(e,t,n)}getLogger(e,t){return super.getLogger(e,t)}}class q{static defaultLogger(e,t){return q.customLogFactory(void 0,void 0,e).getLogger(void 0,t)}static customLogFactory(e,t,n){return new Y(e,t,n)}static customSignLogFactory(e,t){return new Y(void 0,e,t)}}class ee{}c(ee,"LOG_STACK_SIZE",1);const te="1.0.10";class fe{constructor(){c(this,"VERSION"),this.VERSION=te}}class de{constructor(){c(this,"VERSION"),this.VERSION=te}}const T=class{constructor(){c(this,"getQueryString",r=>{if(!T.isInBrowser)return"";const e=window.location.search.substring(1).split("&");for(let t=0;t<e.length;t++){const n=e[t].split("=");if(n[0]===r)return n[1]}return""})}static isInChromeExtension(){return T.isInBrowser?window.location.href.indexOf("chrome-extension://")>-1:!1}};let b=T;c(b,"isInBrowser",typeof window<"u"),c(b,"isElectron",()=>!T.isInBrowser||!window.navigator||!window.navigator.userAgent?!1:/Electron/.test(window.navigator.userAgent)),c(b,"replaceUrlParam",(r,e,t)=>{t==null&&(t="");const n=new RegExp("\\b("+e+"=).*?(&|#|$)");return r.search(n)>=0?r.replace(n,"$1"+t+"$2"):(r=r.replace(/[?#]$/,""),r+(r.indexOf("?")>0?"&":"?")+e+"="+t)}),c(b,"setUrlParameter",(r,e,t)=>T.isInBrowser?r.includes(e)?T.replaceUrlParam(r,e,t):(r+=(r.match(/[?]/g)!=null?"&":"?")+e+"="+t,r):""),c(b,"reloadTabPage",r=>{setTimeout(function(){if(T.isInBrowser){const e=window.location.href;window.location.href=T.setUrlParameter(e,"tab",r)}},200)}),c(b,"reloadPage",()=>{setTimeout(function(){T.isInBrowser&&window.location.reload()},200)}),c(b,"reloadPageWithMessageCallback",(r,e)=>{e&&e(),setTimeout(function(){T.isInBrowser&&window.location.reload()},200)});class B{constructor(){c(this,"isInSiyuanWidget",()=>typeof window>"u"?!1:window.frameElement!=null&&window.frameElement.parentElement!=null&&window.frameElement.parentElement.parentElement!=null&&window.frameElement.parentElement.parentElement.getAttribute("data-node-id")!==""),c(this,"isInSiyuanNewWin",()=>typeof window>"u"?!1:typeof window.terwer<"u"),c(this,"isInSiyuanOrSiyuanNewWin",()=>b.isElectron)}siyuanWindow(){let e;return this.isInSiyuanWidget()?e=parent.window:this.isInSiyuanNewWin()||typeof window<"u"?e=window:e=void 0,e}}class ye{constructor(){c(this,"serverApi"),c(this,"clientApi"),c(this,"siyuanUtil"),this.serverApi=new fe,this.clientApi=new de,this.siyuanUtil=new B}}class we{constructor(){c(this,"VERSION"),this.VERSION="1.0.0"}}class ve{f(e,...t){let n=e;for(let o=0;o<t.length;o++){const i=t[o];typeof i=="string"?n=n.replace(`{${o}}`,i):n=n.replace(`{${o}}`,i.toString())}return n}}class Ee{constructor(){c(this,"TIME_SPLIT"," "),c(this,"formatIsoToZhDate",(e,t,n)=>{if(!e)return"";let o=e;const i=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(.\d{3})Z$/gm,s=o.match(i);if(s==null)return e;for(let a=0;a<s.length;a++){const l=s[a];let m=l;t&&(m=this.addHoursToDate(new Date(l),8).toISOString());const u=m.split("T"),d=u[0],f=u[1].split(".")[0];let v=d+this.TIME_SPLIT+f;n&&(v=d),o=o.replace(l,v)}return o})}addHoursToDate(e,t){return e.setTime(e.getTime()+t*60*60*1e3),e}nowZh(){return this.formatIsoToZhDate(new Date().toISOString())}nowDateZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0,!0)}nowTimeZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0).split(this.TIME_SPLIT)[1]}}const M=(r,e)=>{const t=$(r),n=$(e),o=t.pop(),i=n.pop(),s=J(t,n);return s!==0?s:o&&i?J(o.split("."),i.split(".")):o||i?o?-1:1:0},Le=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,$=r=>{if(typeof r!="string")throw new TypeError("Invalid argument expected string");const e=r.match(Le);if(!e)throw new Error(`Invalid argument not valid semver ('${r}' received)`);return e.shift(),e},H=r=>r==="*"||r==="x"||r==="X",X=r=>{const e=parseInt(r,10);return isNaN(e)?r:e},Se=(r,e)=>typeof r!=typeof e?[String(r),String(e)]:[r,e],be=(r,e)=>{if(H(r)||H(e))return 0;const[t,n]=Se(X(r),X(e));return t>n?1:t<n?-1:0},J=(r,e)=>{for(let t=0;t<Math.max(r.length,e.length);t++){const n=be(r[t]||"0",e[t]||"0");if(n!==0)return n}return 0};class Ie{greater(e,t){return M(e,t)>0}equal(e,t){return M(e,t)===0}lesser(e,t){return M(e,t)<0}}class Te{static getDevice(){const e=new B;return e.isInSiyuanWidget()?"Siyuan_Widget":e.isInSiyuanOrSiyuanNewWin()?"Siyuan_NewWin":b.isInChromeExtension()?"Chrome_Extension":"Chrome_Browser"}}class Oe{constructor(){c(this,"siyuanUtil"),c(this,"requireLib",e=>{const t=this.siyuanUtil.siyuanWindow();return t?t.require(e):require(e)}),c(this,"getCrossPlatformAppDataFolder",()=>{var e,t,n,o,i,s;const a=this.requireLib("path");let l;return((e=this.syProcess())==null?void 0:e.platform)==="darwin"?l=a.join((t=this.syProcess())==null?void 0:t.env.HOME,"/Library/Application Support"):((n=this.syProcess())==null?void 0:n.platform)==="win32"?l=(o=this.syProcess())==null?void 0:o.env.APPDATA:((i=this.syProcess())==null?void 0:i.platform)==="linux"&&(l=(s=this.syProcess())==null?void 0:s.env.HOME),l}),this.siyuanUtil=new B}copyFolderSync(e,t){const n=this,o=this.requireLib("fs"),i=this.requireLib("path");o.existsSync(t)||o.mkdirSync(t),o.lstatSync(e).isDirectory()&&o.readdirSync(e).forEach(function(s){const a=i.join(e,s);o.lstatSync(a).isDirectory()?n.copyFolderSync(a,i.join(t,s)):o.copyFileSync(a,i.join(t,s))})}rmFolder(e){const t=this.requireLib("fs");t.existsSync(e)&&t.rmdirSync(e,{recursive:!0})}joinPath(...e){return this.requireLib("path").join(...e)}dirname(e){return this.requireLib("path").dirname(e)}absPath(e){const t=this.requireLib("path"),n=this.dirname(e);return t.resolve(t.dirname(n),e)}syProcess(){return b.isInBrowser?window.process:process}siyuanConfPath(){const e=this.siyuanUtil.siyuanWindow();if(!e)throw new Error("Not in siyuan env");return e==null?void 0:e.siyuan.config.system.confDir}siyuanDataPath(){const e=this.siyuanUtil.siyuanWindow();if(!e)throw new Error("Not in siyuan env");return e.siyuan.config.system.dataDir}siyuanAppearancePath(){return this.requireLib("path").join(this.siyuanConfPath(),"appearance")}siyuanThemePath(){return this.requireLib("path").join(this.siyuanAppearancePath(),"themes")}zhiThemePath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi")}zhiThemeDistPath(){return this.requireLib("path").join(this.zhiThemePath(),"apps","theme","dist")}zhiBlogDistPath(){return this.requireLib("path").join(this.siyuanThemePath(),"apps","blog","dist")}zhiMiniPath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi-mini")}}class _e{constructor(){c(this,"strUtil"),c(this,"dateUtil"),c(this,"electronUtil"),c(this,"browserUtil"),c(this,"versionUtil"),c(this,"deviceUtil"),this.strUtil=new ve,this.dateUtil=new Ee,this.electronUtil=new Oe,this.browserUtil=b,this.versionUtil=new Ie,this.deviceUtil=Te}}class Pe{constructor(e){c(this,"env"),c(this,"logger"),c(this,"siyuanApi"),c(this,"blogApi"),c(this,"common"),this.env=e,this.logger=q.defaultLogger(this.env,ee.LOG_STACK_SIZE),this.siyuanApi=new ye,this.blogApi=new we,this.common=new _e}getEnv(){if(!this.env)throw new Error("env is not initiated, please use new ZhiSdk(env) create ZhiSdk object!");return this.env}getLogger(){return this.logger}}function Ue(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var re={};(function(r){var e=Object.defineProperty,t=(s,a,l)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[a]=l,n=(s,a,l)=>(t(s,typeof a!="symbol"?a+"":a,l),l);Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});class o{}n(o,"NODE_ENV_KEY","NODE_ENV"),n(o,"VITE_DEBUG_MODE_KEY","VITE_DEBUG_MODE");class i{constructor(a){n(this,"envMeta"),this.envMeta=a}isNodeDev(){return this.getEnv(o.NODE_ENV_KEY)==="development"}isDev(){return this.isNodeDev()||this.getBooleanEnv(o.VITE_DEBUG_MODE_KEY)}getEnv(a){let l;try{this.envMeta[a]&&(l=this.envMeta[a])}catch(m){console.error(m)}return l}getStringEnv(a){return this.getEnv(a)??""}getBooleanEnv(a){let l=!1;return this.getEnv(a)&&(l=this.getStringEnv(a).toLowerCase()==="true"),l}getEnvOrDefault(a,l){const m=this.getStringEnv(a);return m.trim().length==0?l:m}}r.EnvConstants=o,r.default=i})(re);const De=Ue(re),A=class{static zhiSdk(){if(!A.zhiSdkObj){const e=new De({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1});A.zhiSdkObj=new Pe(e)}return A.zhiSdkObj}};let D=A;I(D,"zhiSdkObj");const Ae="0.0.1";var ne=(r=>(r.ThemeFrom_mini_Siyuan="zhi-mini-siyuan",r))(ne||{});const ke=()=>[{libpath:"/icons/fontawesome/js/brands.js",format:"js",importType:"require",runAs:"electron"},{libpath:"/icons/fontawesome/js/solid.js",format:"js",importType:"require",runAs:"electron"},{libpath:"/icons/fontawesome/js/fontawesome.js",format:"js",importType:"require",runAs:"electron"}],Ne={initFontAwesome:ke};class je{constructor(){I(this,"_dynamicImports",[])}get dynamicImports(){return this._dynamicImports}load(){const e=[],t=this.loadPluginSystem(),n=this.loadWidgets(),o=this.loadVendors();this._dynamicImports=e.concat(t).concat(n).concat(o)}loadPluginSystem(){return[]}loadWidgets(){return[]}loadVendors(){const e=[],t=Ne.initFontAwesome();return e.concat(t)}}const k=class{static async start(){return k.lifecycle.load(),Promise.resolve(k.lifecycle.dynamicImports)}};let F=k;I(F,"lifecycle"),(()=>{k.lifecycle=new je})();class Fe{constructor(){I(this,"logger");I(this,"common");const e=D.zhiSdk();this.logger=e.getLogger(),this.common=e.common}async main(e){return this.logger.debug(this.common.strUtil.f("Parsing args <{0}> ...",e)),this.hello(ne.ThemeFrom_mini_Siyuan),await F.start()}hello(e){this.logger.info(this.common.strUtil.f("Hello, {0} {1} v{2}! You are from {3}","zhi","mini",Ae,e))}}class Re{constructor(){I(this,"logger");I(this,"common");I(this,"siyuanApi");I(this,"zhiTheme");const e=D.zhiSdk();this.logger=e.getLogger(),this.common=e.common,this.siyuanApi=e.siyuanApi,this.zhiTheme=new Fe}async init(e){try{const t=await this.zhiTheme.main([]);for(const n of t){const o=n.libpath;if(console.log(n.format),n.format!=="cjs"&&n.format!=="js"){this.logger.warn("Only cjs supported, skip this lib!",o);continue}if(e&&e!==n.runAs){this.logger.warn(this.common.strUtil.f("This lib can only run at {0}, skip!Lib is=>{1}",n.runAs,n.libpath));continue}this.logger.info("Loading dependency=>",o);let i;if(this.common.browserUtil.isInBrowser){const s=this.common.electronUtil.joinPath(this.common.electronUtil.zhiMiniPath(),o);i=this.common.electronUtil.requireLib(s)}i&&i.init&&await i.init()}this.logger.info("Theme inited.")}catch(t){this.logger.error("Theme load error=>",t)}}}function Ve(){const r=Error.prepareStackTrace;Error.prepareStackTrace=(t,n)=>n;const e=new Error().stack.slice(1);return Error.prepareStackTrace=r,e}(async()=>{const r=D.zhiSdk(),e=r.getLogger(),t=r.getEnv(),n=async()=>{e.debug("Theme is loading..."),await new Re().init("electron"),e.debug("Theme loaded.")};if(t.isDev()){const o=Ve(),i="theme.js";(o.length>0?o[0].getFileName()??i:i).includes(i)?await import("http://localhost:5173/theme.ts"):await n()}else await n()})();
